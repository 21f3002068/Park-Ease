{% extends 'user/udash_base.html' %}

{% block title %}User Dashboard{% endblock %}

{% block body %}
{% with messages = get_flashed_messages(with_categories=true) %}
{% if messages %}
<ul class="flash-messages">
    {% for category, message in messages %}
    <li class="flash {{ category }}">{{ message }}</li>
    {% endfor %}
</ul>
{% endif %}
{% endwith %}
{% block content %}

<div class="user-dashboard">
    <!-- User Greeting -->
    <div class="user-greeting">
        <h1>Hello, {{ current_user.firstname if current_user.firstname else 'Parker' }}!</h1>
        <p class="welcome-message">Welcome to your ParkEase dashboard. Let's make parking effortless today!</p>
    </div>

    {% if profile_completion < 100 %} <div class="profile-completion-section">
        <h4 class="profile-completion-title">Complete Your Profile</h4>
        <div class="progress-container">
            <div class="progress-bar" style="width: {{ profile_completion }}%">
                <span class="progress-percent">{{ profile_completion }}%</span>
            </div>
        </div>

        <div class="profile-tasks-container">
            <p class="tasks-title">To complete your profile:</p>
            <ul class="profile-tasks">
                {% if not (user.firstname and user.lastname) %}
                <li class="task-item">
                    <i class="task-icon fas fa-user-edit"></i>
                    <a href="{{ url_for('user.edit_profile') }}" class="task-link">Add your First and Last Name</a>
                </li>
                {% endif %}
                {% if not user.gender %}
                <li class="task-item">
                    <i class="task-icon fas fa-venus-mars"></i>
                    <a href="{{ url_for('user.edit_profile') }}" class="task-link">Add your Gender</a>
                </li>
                {% endif %}
                {% if not user.phone %}
                <li class="task-item">
                    <i class="task-icon fas fa-phone"></i>
                    <a href="{{ url_for('user.edit_profile') }}" class="task-link">Add your Phone Number</a>
                </li>
                {% endif %}
                {% if not (user.address and user.pin) %}
                <li class="task-item">
                    <i class="task-icon fas fa-map-marker-alt"></i>
                    <a href="{{ url_for('user.edit_profile') }}" class="task-link">Add your Address and PIN Code</a>
                </li>
                {% endif %}
                {% if not user.vehicles %}
                <li class="task-item">
                    <i class="task-icon fas fa-car"></i>
                    <a href="{{ url_for('user.add_vehicle') }}" class="task-link">Register a Vehicle</a>
                </li>
                {% endif %}
            </ul>
        </div>
</div>

{% endif %}


<!-- Main Content Grid -->
<div class="dashboard-grid">

    <div class="left-panel">
        <!-- Current Parking (Left Vertical Rectangle) -->
        <div class="current-parking-section">
            <h2><ion-icon name="car-sport-outline"></ion-icon> Currently Parked</h2>

            {% if current_parking %}
            <div class="parking-card">
                <div class="parking-info">
                    <div class="info-row">
                        <span class="label">Vehicle:</span>
                        <span class="value">{{ current_parking.vehicle.vehicle_name }} ({{
                            current_parking.vehicle.license_plate }})</span>
                    </div>
                    <div class="info-row">
                        <span class="label">Location:</span>
                        <span class="value">{{ current_parking.spot.lot.prime_location_name }}</span>
                    </div>
                    <div class="info-row">
                        <span class="label">Spot Number:</span>
                        <span class="value">#{{ current_parking.spot.spot_number }}</span>
                    </div>
                    <div class="info-row">
                        <span class="label">Parked Since:</span>
                        <span class="value">{{ current_parking.parking_timestamp.strftime('%I:%M %p') }}</span>
                    </div>

                    <div class="info-row">
                        <span class="label">Duration:</span>
                        <span class="value">{{ calculate_duration(current_parking.parking_timestamp) }}</span>
                    </div>
                </div>
                <div class="parking-actions">
                    <form action="{{ url_for('user.park_out', reservation_id=current_parking.id) }}" method="POST">
                        <button type="submit" class="park-out-btn">
                            <ion-icon name="exit-outline"></ion-icon> Park Out
                        </button>
                    </form>
                </div>
            </div>
            {% else %}
            <div class="no-parking">
                <p>No active parking session</p>
                <a href="{{url_for('user.search')}}" class="find-parking-btn">
                    <ion-icon name="search-outline"></ion-icon> Find Parking
                </a>
            </div>
            {% endif %}
        </div>

        <div class="upcoming-booking">
            <h2 class="section-title">
                <ion-icon name="calendar-outline"></ion-icon>
                Upcoming Booking
            </h2>

            {% if scheduled_upnext %}
            <div class="booking-card">
                <div class="booking-header">
                    <div class="booking-status active">
                        <ion-icon name="time-outline"></ion-icon>
                        Upcoming
                    </div>
                    <div class="booking-id">#{{ scheduled_upnext.id }}</div>
                </div>

                <div class="booking-info">
                    <div class="info-row">
                        <ion-icon name="car-sport-outline" class="row-icon"></ion-icon>
                        <div class="info-content">
                            <span class="label">Vehicle:</span>
                            <span class="value">{{ scheduled_upnext.vehicle.vehicle_name }} ({{
                                scheduled_upnext.vehicle.license_plate }})</span>
                        </div>
                    </div>

                    <div class="info-row">
                        <ion-icon name="location-outline" class="row-icon"></ion-icon>
                        <div class="info-content">
                            <span class="label">Location:</span>
                            <span class="value">{{ scheduled_upnext.spot.lot.prime_location_name }}</span>
                        </div>
                    </div>

                    <div class="info-row">
                        <ion-icon name="pricetag-outline" class="row-icon"></ion-icon>
                        <div class="info-content">
                            <span class="label">Spot Number:</span>
                            <span class="value">#{{ scheduled_upnext.spot.spot_number }}</span>
                        </div>
                    </div>

                    <div class="time-container">
                        <div class="time-block">
                            <ion-icon name="arrow-forward-circle-outline"></ion-icon>
                            <div>
                                <div class="time-label">Arrival</div>
                                <div class="time-value">{{ scheduled_upnext.expected_arrival.strftime('%I:%M %p') }}
                                </div>
                            </div>
                        </div>

                        <div class="time-block">
                            <ion-icon name="arrow-back-circle-outline"></ion-icon>
                            <div>
                                <div class="time-label">Departure</div>
                                <div class="time-value">{{ scheduled_upnext.expected_departure.strftime('%I:%M %p') }}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="booking-actions">
                    <form action="{{ url_for('user.park', booking_id=scheduled_upnext.id) }}" method="POST">
                        <button type="submit" class="park-btn">
                            <ion-icon name="car-outline"></ion-icon>
                            Start Parking
                        </button>
                    </form>
                </div>
            </div>
            {% else %}
            <div class="no-booking">
                <ion-icon name="calendar-clear-outline" class="empty-icon"></ion-icon>
                <p>No upcoming bookings</p>
                <a href="{{url_for('user.search')}}" class="find-parking-btn">
                    <ion-icon name="search-outline"></ion-icon>
                    Find Parking
                </a>
            </div>
            {% endif %}
        </div>
    </div>



    <!-- Right Column (Vehicles on top, History on bottom) -->
    <div class="right-column">
        <!-- Your Vehicles -->
        <div class="vehicles-section">
            <h2><ion-icon name="car-outline"></ion-icon> Your Vehicles</h2>
            <div class="vehicle-cards">
                {% for vehicle in current_user.vehicles %}
                <div class="vehicle-card">
                    <div class="vehicle-icon">
                        {% if vehicle.vehicle_type == 'car' %}
                        <ion-icon name="car-sport-outline"></ion-icon>
                        {% elif vehicle.vehicle_type == 'bike' %}
                        <ion-icon name="bicycle-outline"></ion-icon>
                        {% else %}
                        <ion-icon name="car-outline"></ion-icon>
                        {% endif %}
                    </div>
                    <div class="vehicle-info">
                        <h3>{{ vehicle.vehicle_name or 'My Vehicle' }}</h3>
                        <p>{{ vehicle.license_plate }}</p>
                        <p>{{ vehicle.color }} • {{ vehicle.vehicle_type or 'vehicle' }}</p>
                    </div>
                </div>
                {% endfor %}
                <div class="add-vehicle-card">
                    <a href="{{ url_for('user.add_vehicle') }}" class="add-vehicle-btn">
                        <ion-icon name="add-outline"></ion-icon>
                        <span>Add Vehicle</span>
                    </a>
                </div>
            </div>
        </div>

        <!-- Parking History -->
        <div class="history-section">
            <h2><ion-icon name="time-outline"></ion-icon> Recent Parking History</h2>
            <div class="history-table">
                {% if parking_history %}
                <table>
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Location</th>
                            <th>Vehicle</th>
                            <th>Duration</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for record in parking_history %}
                        <tr>
                            <td>{{ record.parking_timestamp.strftime('%b %d') }}</td>
                            <td>
                                {% if record.spot and record.spot.lot %}
                                {{ record.spot.lot.prime_location_name }}
                                {% else %}
                                <i>[Location Deleted]</i>
                                {% endif %}
                            </td>
                            <td>{{ record.vehicle.license_plate }}</td>
                            <td>
                                {% if record.leaving_timestamp %}
                                {{ (record.leaving_timestamp - record.parking_timestamp).seconds // 3600 }}h
                                {{ ((record.leaving_timestamp - record.parking_timestamp).seconds % 3600) // 60
                                }}m
                                {% else %}
                                N/A
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                <div class="view-all">
                    <a href="{{ url_for('user.profile') }}#reservation-history">View All</a>
                </div>

                {% else %}
                <p class="no-history">No parking history found</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>


</div>

{% endblock %}
{% endblock %}