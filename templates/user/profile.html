{% extends 'user/udash_base.html' %}


{% block title %}
Profile
{% endblock %}

{% block custom_styles %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<link rel="stylesheet" href="{{url_for('static', filename='style/user/profile.css')}}">
{% endblock %}

{% block body %}
{% with messages = get_flashed_messages(with_categories=true) %}
{% if messages %}
<ul class="flash-messages">
    {% for category, message in messages %}
    <li class="flash {{ category }}">{{ message }}</li>
    {% endfor %}
</ul>
{% endif %}
{% endwith %}
{% block content %}

<div class="container">
    <!-- Profile Header -->
    <div class="profile-header">
        <div class="avatar">
            <i class="fas fa-user"></i>
        </div>
        <div class="profile-info">
            <h1 class="profile-name">
                {% if user.firstname or user.lastname %}
                {{ user.firstname }} {{ user.lastname }}
                {% else %}
                <i>

                    [No Name Provided]
                </i>
                {% endif %}
                <a href="{{ url_for('user.edit_profile') }}" class="edit-profile-link" title="Edit Profile">
                    <i class="fas fa-edit"></i>
                </a>
            </h1>

            <p><i class="fas fa-user"></i> @{{ user.username }}</p>

            <p><i class="fas fa-envelope"></i>
                {{ user.email if user.email else '[Email not provided]' }}
            </p>

            <p><i class="fas fa-phone"></i>
                {% if user.phone %}
                {{ user.phone }}
                {% else %}
                <span class="text-muted">
                    <i>

                        [Phone number not added]
                    </i>
                </span>
                {% endif %}
            </p>

            <p><i class="fas fa-map-marker-alt"></i>
                {% if user.address and user.pin %}
                {{ user.address }}, {{ user.pin }}
                {% elif user.address %}
                {{ user.address }} [No PIN]
                {% elif user.pin %}
                [No address], {{ user.pin }}
                {% else %}
                <span class="text-muted">
                <i>

                    [Address not provided]
                </i>
                </span>
                {% endif %}
            </p>
            <span class="status-badge {% if user.is_active %}status-active{% else %}status-inactive{% endif %}">
                {% if user.is_active %}Active{% else %}Inactive{% endif %}
            </span>
        </div>
        <div class="stats-container">
            <div class="stat-card">
                <div class="stat-label">Total Bookings</div>
                <div class="stat-value">{{ user.reservations|length }}</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Total Spent</div>
                <div class="stat-value">${{ "%.2f"|format(user.reservations|sum(attribute='parking_cost')) }}</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Avg. Rating Given</div>
                <div class="stat-value">
                    {% set valid_reviews = user.reservations|map(attribute='review')|select('defined')|list %}
                    {% set rated_reviews = valid_reviews|selectattr('rating')|list %}
                    {% if rated_reviews %}
                    {{ "%.1f"|format(rated_reviews|sum(attribute='rating') / rated_reviews|length) }} ‚≠ê
                    {% else %}N/A{% endif %}
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Member Since</div>
                <div class="stat-value">{{ user.registration_date.strftime('%b %Y') }}</div>
            </div>
        </div>

    </div>

    <div class="mid-section">

        <!-- Favorites Section -->
        <div class="saved-parking-div">
            <div class="section-header-1">
                <h2 class="section-title-1"><i class="fas fa-heart"></i> Saved Parking Lots</h2>
            </div>

            {% if favorites %}
            <div class="card-container">
                {% for lot in favorites %}
                <div class="parking-card">
                    <div class="card-header">
                        <h3>{{ lot.prime_location_name }}</h3>
                        <span class="price-tag">${{ "%.2f"|format(lot.price_per_hour) }}/hr</span>
                    </div>
                    <div class="card-body">
                        <p class="location"><i class="fas fa-map-marker-alt"></i> {{ lot.location_ref.name }}</p>
                        <div class="card-actions">
                            <a href="{{ url_for('user.book_parking', lot_id=lot.id) }}" class="btn btn-primary">
                                <i class="fas fa-calendar-alt"></i> Book
                            </a>
                            <button class="btn btn-outline-danger" onclick="removeFavorite({{ lot.id }})">
                                <i class="fas fa-trash"></i> Remove
                            </button>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div class="empty-state">
                <i class="fas fa-heart"></i>
                <h3>No Saved Parking Lots</h3>
                <p>Save your favorite parking lots for quick access when booking</p>
                <a href="{{ url_for('user.locations') }}" class="btn btn-primary">
                    <i class="fas fa-search"></i> Explore Parkings
                </a>
            </div>
            {% endif %}
        </div>


        <!-- Vehicles Section -->
        <div class="my-vehicle-div">
            <div class="section-header-1">
                <h2 class="section-title-1"><i class="fas fa-car"></i> My Vehicles</h2>
                <div class="add-vehicle-btn">
                    <button class="btn btn-primary" onclick="showAddVehicleForm()">
                        <i class="fas fa-plus"></i>
                        <a href="{{url_for('user.add_vehicle')}}" class="add-vehicle-link">

                            Add Vehicle
                        </a>
                    </button>
                </div>
            </div>

            {% if user.vehicles %}
            <div class="card-container">
                {% for vehicle in user.vehicles %}
                <div class="vehicle-card" data-vehicle-id="{{ vehicle.id }}">
                    <div class="card-header">
                        <h3>{{ vehicle.vehicle_name }}</h3>
                        <span class="license-plate">{{ vehicle.license_plate }}</span>
                    </div>
                    <div class="card-body">
                        <div class="vehicle-color">
                            <span class="color-swatch" style="background-color: {{ vehicle.color }};"></span>
                            <span class="color-value">{{ vehicle.color }}</span>
                        </div>
                        <div class="card-actions">
                            <a href="{{ url_for('user.edit_vehicle', vehicle_id=vehicle.id) }}"
                                class="vehicle-action edit-action" title="Edit">
                                <i class="fas fa-edit"></i>
                            </a>
                            <form action="{{ url_for('user.delete_vehicle', vehicle_id=vehicle.id) }}" method="POST"
                                style="display: inline;">
                                <button type="submit" class="vehicle-action delete-action" title="Delete Vehicle">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </form>
                        </div>

                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div class="empty-state">
                <i class="fas fa-car"></i>
                <h3>No Vehicles Registered</h3>
                <p>Add your first vehicle to get started with parking reservations</p>
                <button class="btn btn-primary" onclick="showAddVehicleForm()">
                    <i class="fas fa-plus"></i> Add Vehicle
                </button>
            </div>
            {% endif %}
        </div>
    </div>
    <!-- Reservations Section -->
    <div class="section" id="reservation-history">
        <div class="section-header">
            <h2 class="section-title"><i class="fas fa-calendar-alt"></i> Reservation History</h2>
        </div>

        {% if user.reservations %} 
        <table>
            <thead>
                <tr>
                    <th>Booking ID</th>
                    <th>Parking Lot</th>
                    <th>Spot</th>
                    <th>Vehicle</th>
                    <th>Parking Time</th>
                    <th>Leaving Time</th>
                    <th>Cost</th>
                    <th>Status</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for reservation in user.reservations|selectattr('parking_timestamp')|sort(attribute='parking_timestamp', reverse=True) %}
                <tr>
                    <td>{{ reservation.booking_id }}</td>
                    <td>{{ reservation.spot.lot.prime_location_name }}</td>
                    <td>{{ reservation.spot.spot_number }}</td>
                    <td>{{ reservation.vehicle.license_plate }}</td>
                    <td>{{ reservation.parking_timestamp.strftime('%I:%M %p') }}</td>
                    <td>
                        {% if reservation.leaving_timestamp %}
                            {{ reservation.leaving_timestamp.strftime('%I:%M %p') }}
                        {% else %}N/A{% endif %}
                    </td>                    
                    <td>${{ "%.2f"|format(reservation.parking_cost) }}</td>
                    <td class="status-{{ reservation.status|lower }}">
                        {{ reservation.status }}
                        {% if reservation.cancellation_reason %}
                        <br><small>Reason: {{ reservation.cancellation_reason }}</small>
                        {% endif %}
                    </td>
                    <td>
                        {% if reservation.status == 'Confirmed' and not reservation.review %}
                        <button class="btn btn-outline" onclick="showReviewForm({{ reservation.id }})">
                            <i class="fas fa-star"></i> Review
                        </button>
                        {% endif %}
                        {% if reservation.spot.lot.is_active %}
                        <a href="{{ url_for('user.book_parking', lot_id=reservation.spot.lot.id) }}"
                            class="btn btn-outline">
                            <i class="fas fa-redo"></i> Rebook
                        </a>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% else %}
        <div class="empty-state">
            <i class="fas fa-calendar-times"></i>
            <h3>No Reservations Yet</h3>
            <p>Book your first parking spot to see your reservation history here</p>
            <a href="{{ url_for('user.locations') }}" class="btn btn-primary">
                <i class="fas fa-calendar-alt"></i> Book a parking
            </a>
        </div>
        {% endif %}
    </div>

    <!-- Reviews Section -->
    <div class="section">
        <div class="section-header">
            <h2 class="section-title"><i class="fas fa-star"></i> My Reviews</h2>
        </div>

        {% set user_reviews = user.reservations|map(attribute='review')|select('defined')|list %}
        {% if user_reviews %}
        <table>
            <thead>
                <tr>
                    <th>Rating</th>
                    <th>Comment</th>
                    <th>Parking Lot</th>
                    <th>Date</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for review in user_reviews if review %}
                <tr>
                </tr>
                <td>{{ review.comment }}</td>
                <td>
                    {% if review.reservation %}
                    {{ review.reservation.spot.lot.prime_location_name }}
                    {% else %}
                    No associated parking
                    {% endif %}
                </td>
                <td>{{ review.created_at.strftime('%b %d, %Y') }}</td>
                <td>
                    <button class="btn btn-outline" onclick="editReview({{ review.id }})">
                        <i class="fas fa-edit"></i> Edit
                    </button>
                </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% else %}
        <div class="empty-state">
            <i class="fas fa-star"></i>
            <h3>No Reviews Yet</h3>
            <p>Complete a parking reservation to leave your first review</p>
        </div>
        {% endif %}
    </div>

    <div class="danger-zone">
        <h4 class="danger-zone-title">
            <i class="fas fa-exclamation-triangle"></i> Danger Zone
        </h4>
        <div class="danger-zone-content">
            <p class="danger-zone-warning">
                <strong>Warning:</strong> Deleting your account is permanent and cannot be undone.
                All your data, vehicles, and history will be permanently removed.
            </p>

            <button class="btn-delete-account" id="deleteAccountBtn">
                <i class="fas fa-trash-alt"></i> Delete My Account
            </button>

            <!-- Confirmation Modal (hidden by default) -->
            <div class="delete-confirm-modal" id="deleteConfirmModal">
                <div class="modal-content">
                    <h5>Confirm Account Deletion</h5>
                    <p>Are you absolutely sure you want to delete your account? This action cannot be undone.</p>
                    <div class="modal-actions">
                        <button class="btn-cancel" id="cancelDeleteBtn">Cancel</button>
                        <form action="{{ url_for('user.delete_account') }}" method="POST" style="display: inline;">
                            <button type="submit" class="btn-confirm-delete">
                                <i class="fas fa-trash-alt"></i> Yes, Delete My Account
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

</div>

<script>
    // Placeholder functions for the interactive elements
    function showAddVehicleForm() {
        alert("Show form to add new vehicle");
        // In a real implementation, this would show a modal or redirect
    }

    function editVehicle(vehicleId) {
        alert("Edit vehicle with ID: " + vehicleId);
    }

    function confirmDeleteVehicle(vehicleId) {
        if (confirm("Are you sure you want to remove this vehicle?")) {
            alert("Delete vehicle with ID: " + vehicleId);
            // In a real implementation, this would make an API call
        }
    }

    function showReviewForm(reservationId) {
        alert("Show review form for reservation: " + reservationId);
    }

    function editReview(reviewId) {
        alert("Edit review with ID: " + reviewId);
    }

    function removeFavorite(lotId) {
        if (confirm("Remove this parking lot from your favorites?")) {
            alert("Remove favorite lot ID: " + lotId);
            // In a real implementation, this would make an API call
        }
    }


    document.getElementById('deleteAccountBtn').addEventListener('click', function () {
        document.getElementById('deleteConfirmModal').style.display = 'flex';
    });

    document.getElementById('cancelDeleteBtn').addEventListener('click', function (e) {
        e.preventDefault();
        document.getElementById('deleteConfirmModal').style.display = 'none';
    });

    // Close modal when clicking outside
    window.addEventListener('click', function (event) {
        const modal = document.getElementById('deleteConfirmModal');
        if (event.target === modal) {
            modal.style.display = 'none';
        }
    });

</script>

{% endblock %}
{% endblock %}