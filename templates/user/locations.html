{% extends 'user/udash_base.html' %}

{% block title %}Parking Locations{% endblock %}

{% block custom_styles %}
<link rel="stylesheet" href="{{ url_for('static', filename='/style/user/locations.css') }}">
{% endblock%}

{% block body %}
{% with messages = get_flashed_messages(with_categories=true) %}
{% if messages %}
<ul class="flash-messages">
    {% for category, message in messages %}
    <li class="flash {{ category }}">{{ message }}</li>
    {% endfor %}
</ul>
{% endif %}
{% endwith %}
{% block content %}

<div class="locations-wrapper">
    {% for item in lot_data %}
    <div class="location-section">
        <div class="location-header">
            <h2>
                <ion-icon name="business-outline"></ion-icon>
                {{ item.name }}
            </h2>
        </div>

        <p class="location-address">
            <ion-icon name="location-outline"></ion-icon>
            {{ item.address }}, {{ item.pin_code }} | Currently available: {{ item.currently_available_spots }} | Total Parking Spots: {{
            item.available_spots }} |   Max Capacity: {{item.total_spots}}
            <!-- Total available parking spots is the sum of available parking spots for ALL parking lots of a location when admin creates a new parking lot
             That is, this -> available_spots = db.Column(db.Integer, nullable=False)
             -->
        </p>
        <div class="lot-cards">
            {% for lot in item.lots %}
            <div class="lot-card">

                <h3>


                    {{ lot.prime_location_name }}

                    <div class="status-dot {% if lot.is_active %}active{% else %}inactive{% endif %}"></div>

                </h3>


                <div class="card-details">

                    <p><strong>
                            <ion-icon name="pricetag-outline" class="detail-icon"></ion-icon>
                            Price/hr:</strong> â‚¹{{ lot.price_per_hour }}</p>
                    <p><strong>
                            <ion-icon name="car-sport-outline" class="detail-icon"></ion-icon>
                            Available Spots:</strong> {{ lot.currently_available_spots }}/{{ lot.available_spots }}
                            <!-- currently available spots are all spots that are CURRENTLY empty. That is, no car is parked at given moment.
                             A lot can have 100 parking lot capacity and admin makes 60 spots available, if at current moment there is only 10 cars parked in the 
                             parking lot then currently available spots is 50-->
                    </p>
                    <p><strong>
                            <ion-icon name="time-outline" class="detail-icon"></ion-icon>
                            Time:</strong>
                        {{ lot.available_from.strftime('%I:%M %p') }} - {{ lot.available_to.strftime('%I:%M %p') }}
                    </p>
                </div>

                <!-- User Actions -->
                <div class="card-actions">
                    <!-- View Details Button -->
                    <a href="{{ url_for('user.view_parking_details', lot_id=lot.id) }}" class="action-btn details-btn"
                        title="View Details">
                        <ion-icon name="information-circle-outline"></ion-icon>
                        <span class="action-label">Details</span>
                    </a>

                    <!-- Book Now Button -->
                    <a href="{{ url_for('user.book_parking', lot_id=lot.id) }}" class="action-btn book-btn 
                    {% if not lot.is_active %} 
                    
                    disabled
                    
                    {% endif %}" {% if not lot.is_active %} aria-disabled="true" {%endif %}>


                        <ion-icon name="calendar-outline"></ion-icon>
                        Book
                    </a>


                    <!-- Favorite Button -->
                    <button class="action-btn favorite-btn" title="Add to Favorites"
                        onclick="toggleFavorite({{ lot.id }})">
                        <ion-icon id="fav-icon-{{ lot.id }}"
                            name="{% if lot.id in favorite_lot_ids %}heart{% else %}heart-outline{% endif %}">
                        </ion-icon>
                        <span class="action-label">Save</span>
                    </button>

                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endfor %}
</div>

<div class="find-parking">

    <a href="{{url_for('user.search')}}" class="find-parking-btn">
        <ion-icon name="search-outline"></ion-icon> Find Parking Near Me
    </a>
</div>


<script>
    function toggleFavorite(lotId) {
        const icon = document.getElementById(`fav-icon-${lotId}`);

        if (icon.getAttribute('name') === 'heart-outline') {
            icon.setAttribute('name', 'heart');
            fetch(`/user/favorites/${lotId}`, { method: 'POST' })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showToast('Added to favorites');
                    }
                });
        } else {
            icon.setAttribute('name', 'heart-outline');
            fetch(`/user/favorites/${lotId}`, { method: 'DELETE' })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showToast('Removed from favorites');
                    }
                });
        }
    }

    function removeFavorite(lotId) {
        fetch(`/user/favorites/${lotId}`, { method: 'DELETE' })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    location.reload(); // refresh the page to reflect removal
                }
            });
    }


    function showToast(message) {
        console.log(message);
    }
</script>


<script>
    // Wait for the page to load
    window.addEventListener('DOMContentLoaded', () => {
      // Find all flash messages
      const flashMessages = document.querySelectorAll('.flash');
  
      // Set a timeout to remove them after 5 seconds (5000 ms)
      setTimeout(() => {
        flashMessages.forEach(msg => {
          msg.style.transition = 'opacity 0.5s ease';
          msg.style.opacity = '0';
          setTimeout(() => msg.remove(), 500); // Fully remove after fade out
        });
      }, 5000);
    });
  </script>
  

{% endblock %}
{% endblock %}