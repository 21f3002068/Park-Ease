{% extends '/user/udash_base.html' %}

{% block title %}user Dashboard{% endblock %}


{% block custom_styles %}
<link href="{{ url_for('static', filename='style/user/bookings.css') }}" rel="stylesheet">
{% endblock %}



{% block body %}

{% with messages = get_flashed_messages(with_categories=true) %}
{% if messages %}
<ul class="flash-messages">
    {% for category, message in messages %}
    <li class="flash {{ category }}">{{ message }}</li>
    {% endfor %}
</ul>
{% endif %}
{% endwith %}

{% block user_greeting %}
<div class="user-greeting">

    {% if current_parking %}
    <div class="current-parking-status">
        <div class="parking-info">
            <div class="vehicle-info">
                <i class="fas fa-car"></i>
                <div>
                    <h3>Your Vehicle <span class="vehicle-name">{{ current_parking.vehicle.vehicle_name }}</span></h3>
                    <p class="license-plate">License Plate: <span class="license-plate-text">{{ current_parking.vehicle.license_plate }}</span></p>
                </div>
            </div>
            
            <div class="location-info">
                <i class="fas fa-map-marker-alt"></i>
                <p>Currently parked at <strong><span style="color: #208ffe; background-color: #208ffe4a; border-radius: 5px; padding: 5px;">{{ current_parking.spot.lot.prime_location_name }}</span></strong> in <strong><span class="spot-number" style="color: #208ffe; background-color: #208ffe4a; border-radius: 5px; padding: 5px;">Spot #{{ current_parking.spot.spot_number }}</span></strong></p>
            </div>
        </div>
        
        <form action="{{ url_for('user.park_out', reservation_id=current_parking.id) }}" method="POST" class="park-out-form">
            <button type="submit" class="park-out-btn">
                <ion-icon name="exit-outline"></ion-icon> 
                <span>Park Out</span>
            </button>
        </form>
    </div>
    {% endif %}

</div>
{% endblock %}


{% block content %}
<div class="user-dashboard">

    <div class="dashboard-grid">
        <!-- Current Bookings -->
        <div class="panel current-bookings">
            <h3 class="panel-heading">Confirmed Bookings | {{ active_bookings|length }}</h3>
            <div class="table-container">
                <table class="parking-table">
                    <thead>
                        <tr>
                            <th>B. ID</th>
                            <th>Parking Lot</th>
                            <th>Spot #</th>
                            <th>Vehicle</th>
                            <th>Scheduled</th>

                        </tr>
                    </thead>
                    <tbody>
                        {% for booking in active_bookings %}
                        <tr>
                            <td>
                                <small>
                                    <a href="{{ url_for('user.booking_details', booking_id=booking.booking_id) }}"
                                        class="bid-link">
                                        {{ booking.booking_id }}
                                    </a>

                                </small>
                            </td>
                            <td>{{ booking.spot.lot.prime_location_name }}</td>
                            <td>{{ booking.spot.spot_number }}</td>
                            <td>
                                <small>
                                    {{ booking.vehicle.license_plate }}
                                </small>

                            </td>
                            <td>{{ booking.expected_arrival.strftime('%I:%M %p') }}</td>
                        </tr>
                        {% else %}
                        <tr class="empty">
                            <td colspan="7">No active parking bookings</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Pending Requests -->
        <div class="panel pending-requests">
            <h3 class="panel-heading">Pending Requests | {{ pending_requests|length }}</h3>
            <div class="table-container">
                <table class="parking-table">
                    <thead>
                        <tr>
                            <th>B. ID</th>
                            <th>Parking Lot</th>
                            <th>Vehicle</th>
                            <th>Requested Time</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for request in pending_requests %}
                        <tr>
                            <td>
                                <small>
                                    <a href="{{url_for('user.booking_details' , booking_id=request.booking_id)}}"
                                        class="bid-link">

                                        {{ request.booking_id }}
                                    </a>
                                </small>
                            </td>
                            <td>
                                {% if request.spot %}
                                {{ request.spot.lot.prime_location_name }}
                                {% elif request.lot %}
                                {{ request.lot.prime_location_name }}
                                {% else %}
                                Awaiting spot assignment
                                {% endif %}
                            </td>
                            <td>
                                <small>
                                    {{ request.vehicle.license_plate }}
                                </small>
                            </td>
                            <td>{{ request.expected_arrival.strftime('%I:%M %p') }}</td>
                        </tr>
                        {% else %}
                        <tr class="empty">
                            <td colspan="6">No pending requests</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Cancelled/Rejected Bookings -->
        <div class="panel cancelled-bookings">
            <h3 class="panel-heading">Cancelled/Rejected Bookings | {{ cancelled_bookings|length }}</h3>
            <div class="table-container">
                <table class="parking-table">
                    <thead>
                        <tr>
                            <th>B. ID</th>
                            <th>Parking Lot</th>
                            <th>Status</th>
                            <th>Reason</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for booking in cancelled_bookings %}
                        <tr>
                            <td>
                                <small>
                                    <a href="{{url_for('user.booking_details', booking_id=booking.booking_id)}}"
                                        class="bid-link">
                                        {{ booking.booking_id }}
                                    </a>
                                </small>
                            </td>
                            <td>{{ booking.lot.prime_location_name }}</td>
                            <td>
                                <span class="status {{ booking.status|lower }}">{{ booking.status }}</span>
                            </td>
                            <td>
                                <small>

                                    {{ booking.cancellation_reason or "User cancelled" }}
                                </small>
                            </td>
                        </tr>
                        {% else %}
                        <tr class="empty">
                            <td colspan="6">No cancelled/rejected bookings</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Parking History -->
        <div class="panel parking-history">
            <h3 class="panel-heading">Parking History | {{ parking_history|length }}</h3>
            <div class="table-container">
                <table class="parking-table">
                    <thead>
                        <tr>
                            <th>B. ID</th>
                            <th>Entry Time</th>
                            <th>Exit Time</th>
                            <th>Amount</th>
                            <th>Rating</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for history in parking_history %}
                        <tr>
                            <td>
                                <small>
                                    <a href="{{url_for('user.booking_details', booking_id=history.booking_id)}}"
                                        class="bid-link">
                                        {{ history.booking_id}}
                                    </a>
                                </small>
                            </td>
                            <td>{{ history.parking_timestamp.strftime('%I:%M %p') }}</td>
                            <td>{{ history.leaving_timestamp.strftime('%I:%M %p') if history.leaving_timestamp
                                else 'N/A' }}</td>
                            <td>₹{{ history.parking_cost|int }}</td>
                            <td>
                                <small>
                                    {% if history.review %}
                                    {% for i in range(1,6) %}
                                    {% if i <= history.review.rating %} ★ {% else %} ☆ {% endif %} {% endfor %} {% else
                                        %} <a href="{{ url_for('user.add_review', reservation_id=history.id) }}"
                                        class="review-btn minimalist">
                                        <ion-icon name="create-outline"></ion-icon>
                                        Add Review
                                        </a>
                                        {% endif %}
                                </small>
                            </td>
                        </tr>
                        {% else %}
                        <tr class="empty">
                            <td colspan="7">No parking history found</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>


<script>
    // Wait for the page to load
    window.addEventListener('DOMContentLoaded', () => {
        // Find all flash messages
        const flashMessages = document.querySelectorAll('.flash');

        // Set a timeout to remove them after 5 seconds (5000 ms)
        setTimeout(() => {
            flashMessages.forEach(msg => {
                msg.style.transition = 'opacity 0.5s ease';
                msg.style.opacity = '0';
                setTimeout(() => msg.remove(), 500); // Fully remove after fade out
            });
        }, 5000);
    });
</script>


{% endblock %}

{% endblock %}