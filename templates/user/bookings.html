{% extends '/user/udash_base.html' %}

{% block title %}user Dashboard{% endblock %}


{% block custom_styles %}
<link href="{{ url_for('static', filename='style/user/bookings.css') }}" rel="stylesheet">
{% endblock %}



{% block body %}

{% block user_greeting %}
<div class="user-greeting">
    {% if current_user %}
    Hi, {{ current_user.firstname }}!
    {% else %}
    Hi, Guest!
    {% endif %}
</div>
{% endblock %}


{% block content %}
<div class="user-dashboard">

    <div class="dashboard-grid">
        <!-- Current Bookings -->
        <div class="panel current-bookings">
            <h3 class="panel-heading">Active Parking Bookings</h3>
            <div class="table-container">
                <table class="parking-table">
                    <thead>
                        <tr>
                            <th>Booking ID</th>
                            <th>Parking Lot</th>
                            <th>Spot #</th>
                            <th>Vehicle</th>
                            <th>Entry Time</th>
                            <th>Status</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for booking in active_bookings %}
                        <tr>
                            <td>#PARK{{ booking.id }}</td>
                            <td>{{ booking.spot.lot.prime_location_name }}</td>
                            <td>{{ booking.spot.spot_number }}</td>
                            <td>{{ booking.vehicle.license_plate }}</td>
                            <td>{{ booking.parking_timestamp.strftime('%Y-%m-%d %H:%M') }}</td>
                            <td><span class="status active">Active</span></td>
                            <td>
                                <button class="checkout-btn" data-booking-id="{{ booking.id }}">
                                    Check Out
                                </button>
                            </td>
                        </tr>
                        {% else %}
                        <tr class="empty">
                            <td colspan="7">No active parking bookings</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Pending Requests -->
        <div class="panel pending-requests">
            <h3 class="panel-heading">Pending Parking Requests</h3>
            <div class="table-container">
                <table class="parking-table">
                    <thead>
                        <tr>
                            <th>Request ID</th>
                            <th>Parking Lot</th>
                            <th>Vehicle</th>
                            <th>Requested Time</th>
                            <th>Status</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for request in pending_requests %}
                        <tr>
                            <td>#REQ{{ request.id }}</td>
                            <td>
                                {% if request.spot %}
                                {{ request.spot.lot.prime_location_name }}
                                {% elif request.lot %}
                                {{ request.lot.prime_location_name }}
                                {% else %}
                                Awaiting spot assignment
                                {% endif %}
                            </td>
                            <td>{{ request.vehicle.license_plate }}</td>
                            <td>{{ request.parking_timestamp.strftime('%Y-%m-%d %H:%M') }}</td>
                            <td><span class="status pending">Pending</span></td>
                            <td>
                                <form action="{{ url_for('user.cancel_booking', request_id=request.id) }}" method="POST"
                                    style="display: inline;">
                                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                    <button type="submit" class="cancel-btn"
                                        onclick="return confirm('Are you sure you want to cancel this booking?');">
                                        Cancel
                                    </button>
                                </form>
                            </td>
                        </tr>
                        {% else %}
                        <tr>
                            <td colspan="6">No pending requests</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Cancelled/Rejected Bookings -->
        <div class="panel cancelled-bookings">
            <h3 class="panel-heading">Cancelled/Rejected Bookings</h3>
            <div class="table-container">
                <table class="parking-table">
                    <thead>
                        <tr>
                            <th>Booking ID</th>
                            <th>Parking Lot</th>
                            <th>Vehicle</th>
                            <th>Requested Time</th>
                            <th>Status</th>
                            <th>Reason</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for booking in cancelled_bookings %}
                        <tr>
                            <td>#CAN{{ booking.id }}</td>
                            <td>{{ booking.spot.lot.prime_location_name }}</td>
                            <td>{{ booking.vehicle.license_plate }}</td>
                            <td>{{ booking.parking_timestamp.strftime('%Y-%m-%d %H:%M') }}</td>
                            <td><span class="status cancelled">{{ booking.status }}</span></td>
                            <td>{{ booking.cancellation_reason or "User cancelled" }}</td>
                        </tr>
                        {% else %}
                        <tr class="empty">
                            <td colspan="6">No cancelled/rejected bookings</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Parking History -->
        <div class="panel parking-history">
            <h3 class="panel-heading">Parking History</h3>
            <div class="table-container">
                <table class="parking-table">
                    <thead>
                        <tr>
                            <th>Booking ID</th>
                            <th>Parking Lot</th>
                            <th>Vehicle</th>
                            <th>Entry Time</th>
                            <th>Exit Time</th>
                            <th>Amount</th>
                            <th>Review</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for history in parking_history %}
                        <tr>
                            <td>#HIS{{ history.id }}</td>
                            <td>{{ history.spot.lot.prime_location_name }}</td>
                            <td>{{ history.vehicle.license_plate }}</td>
                            <td>{{ history.parking_timestamp.strftime('%Y-%m-%d %H:%M') }}</td>
                            <td>{{ history.leaving_timestamp.strftime('%Y-%m-%d %H:%M') if history.leaving_timestamp
                                else 'N/A' }}</td>
                            <td>₹{{ history.parking_cost }}</td>
                            <td>
                                {% if history.review %}
                                {{ history.review.rating }}★
                                {% else %}
                                <button class="review-btn" data-booking-id="{{ history.id }}">
                                    Add Review
                                </button>
                                {% endif %}
                            </td>
                        </tr>
                        {% else %}
                        <tr class="empty">
                            <td colspan="7">No parking history found</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>




{% endblock %}

{% endblock %}