{% extends '/user/udash_base.html' %}

{% block title %}user Dashboard{% endblock %}


{% block custom_styles %}
<link href="{{ url_for('static', filename='style/user/bookings.css') }}" rel="stylesheet">
{% endblock %}



{% block body %}

{% with messages = get_flashed_messages(with_categories=true) %}
{% if messages %}
<ul class="flash-messages">
    {% for category, message in messages %}
    <li class="flash {{ category }}">{{ message }}</li>
    {% endfor %}
</ul>
{% endif %}
{% endwith %}

{% block user_greeting %}
<div class="user-greeting">

    {% if current_parking %}
    Your vehicle {{ current_parking.vehicle.vehicle_name }}
    ({{current_parking.vehicle.license_plate }}) is currently parked at {{ current_parking.spot.lot.prime_location_name
    }}.
    <div class="parkout-btn">
        <div class="parking-actions">
            <form action="{{ url_for('user.park_out', reservation_id=current_parking.id) }}" method="POST">
                <button type="submit" class="park-out-btn">
                    <ion-icon name="exit-outline"></ion-icon> Park Out
                </button>
            </form>
        </div>
    </div>
    {% endif %}

</div>
{% endblock %}


{% block content %}
<div class="user-dashboard">

    <div class="dashboard-grid">
        <!-- Current Bookings -->
        <div class="panel current-bookings">
            <h3 class="panel-heading">Confirmed Bookings</h3>
            <div class="table-container">
                <table class="parking-table">
                    <thead>
                        <tr>
                            <th>B. ID</th>
                            <th>Parking Lot</th>
                            <th>Spot #</th>
                            <th>Vehicle</th>
                            <th>Scheduled</th>

                        </tr>
                    </thead>
                    <tbody>
                        {% for booking in active_bookings %}
                        <tr>
                            <td>#PARK{{ booking.id }}</td>
                            <td>{{ booking.spot.lot.prime_location_name }}</td>
                            <td>{{ booking.spot.spot_number }}</td>
                            <td>{{ booking.vehicle.license_plate }}</td>
                            <td>{{ booking.expected_arrival.strftime('%I:%M %p') }}</td>
                        </tr>
                        {% else %}
                        <tr class="empty">
                            <td colspan="7">No active parking bookings</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Pending Requests -->
        <div class="panel pending-requests">
            <h3 class="panel-heading">Pending Requests</h3>
            <div class="table-container">
                <table class="parking-table">
                    <thead>
                        <tr>
                            <th>B. ID</th>
                            <th>Parking Lot</th>
                            <th>Vehicle</th>
                            <th>Requested Time</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for request in pending_requests %}
                        <tr>
                            <td>#REQ{{ request.id }}</td>
                            <td>
                                {% if request.spot %}
                                {{ request.spot.lot.prime_location_name }}
                                {% elif request.lot %}
                                {{ request.lot.prime_location_name }}
                                {% else %}
                                Awaiting spot assignment
                                {% endif %}
                            </td>
                            <td>{{ request.vehicle.license_plate }}</td>
                            <td>{{ request.parking_timestamp.strftime('%I:%M %p') }}</td>
                        </tr>
                        {% else %}
                        <tr class="empty">
                            <td colspan="6">No pending requests</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Cancelled/Rejected Bookings -->
        <div class="panel cancelled-bookings">
            <h3 class="panel-heading">Cancelled/Rejected Bookings</h3>
            <div class="table-container">
                <table class="parking-table">
                    <thead>
                        <tr>
                            <th>B. ID</th>
                            <th>Parking Lot</th>
                            <th>Status</th>
                            <th>Reason</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for booking in cancelled_bookings %}
                        <tr>
                            <td>#CAN{{ booking.id }}</td>
                            <td>{{ booking.spot.lot.prime_location_name }}</td>
                            <td><span class="status cancelled">{{ booking.status }}</span></td>
                            <td>{{ booking.cancellation_reason or "User cancelled" }}</td>
                        </tr>
                        {% else %}
                        <tr class="empty">
                            <td colspan="6">No cancelled/rejected bookings</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Parking History -->
        <div class="panel parking-history">
            <h3 class="panel-heading">Parking History</h3>
            <div class="table-container">
                <table class="parking-table">
                    <thead>
                        <tr>
                            <th>B. ID</th>
                            <th>Entry Time</th>
                            <th>Exit Time</th>
                            <th>Amount</th>
                            <th>Review</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for history in parking_history %}
                        <tr>
                            <td>#HIS{{ history.id }}</td>
                            <td>{{ history.parking_timestamp.strftime('%I:%M %p') }}</td>
                            <td>{{ history.leaving_timestamp.strftime('%I:%M %p') if history.leaving_timestamp
                                else 'N/A' }}</td>
                                <td>₹{{ history.parking_cost|int }}</td>
                                <td>
                                {% if history.review %}
                                {{ history.review.rating }}★
                                {% else %}
                                <button class="review-btn" data-booking-id="{{ history.id }}">
                                    Add Review
                                </button>
                                {% endif %}
                            </td>
                        </tr>
                        {% else %}
                        <tr class="empty">
                            <td colspan="7">No parking history found</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>




{% endblock %}

{% endblock %}