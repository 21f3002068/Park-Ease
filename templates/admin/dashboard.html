{% extends 'admin/adash_base.html' %}


{% block title %}Admin Dashboard{% endblock %}

{% block custom_styles %}
<link rel="stylesheet" href="{{ url_for('static', filename='/style/admin/admin_dashboard.css') }}">
{% endblock%}


{% block body %}
{% with messages = get_flashed_messages(with_categories=true) %}
{% if messages %}
<ul class="flash-messages">
    {% for category, message in messages %}
    <li class="flash {{ category }}">{{ message }}</li>
    {% endfor %}
</ul>
{% endif %}
{% endwith %}
{% block content %}

<div class="slot-legend">
    <!-- <h4>Parking Spot Status:</h4> -->
    <div class="legend-items">
        <div class="centered">

            <div class="legend-item">
                <div class="legend-box available"></div>
                <span>Available</span>
            </div>
            <div class="legend-item">
                <div class="legend-box booked"></div>
                <span>Booked</span>
            </div>
            <div class="legend-item">
                <div class="legend-box occupied"></div>
                <span>Occupied</span>
            </div>
            <div class="legend-item">
                <div class="legend-box unavailable"></div>
                <span>Unavailable</span>
            </div>
            
        </div>
    </div>
</div>
<div class="parking-dashboard">
    {% if parking_lots %}
    {% set sorted_parking_lots = parking_lots | sort(attribute='occupied_spots', reverse=True) %}

    {% for lot in parking_lots %}
    {% set occupied_spots = false %}
    {% for spot in lot.spots %}
    {% if not occupied_spots and spot.status != 'A' %}
    {% set occupied_spots = true %}
    {% endif %}
    {% endfor %}

    <div class="parking-card">
        <div class="card-header">
            <h3>{{ lot.prime_location_name }}</h3>
            <div class="dropdown">
                <button class="three-dots">â‹®</button>
                <div class="dropdown-menu">
                    <a href="{{ url_for('admin.edit_parking', lot_id=lot.id) }}">Edit</a>

                    {% if not occupied_spots %}
                    <form action="{{ url_for('admin.delete_parking', lot_id=lot.id) }}" method="POST"
                        style="display: inline;"
                        onsubmit="return confirm('Are you sure you want to delete this parking lot?');">
                        <button type="submit" class="dropdown-item delete-btn">Delete</button>
                    </form>
                    {% else %}
                    <button class="dropdown-item delete-btn" disabled
                        title="Cannot delete: Some spots are occupied">Delete</button>
                    {% endif %}
                </div>
            </div>
        </div>

        <p class="slot-info">{{ lot.occupied_spots or 0 }} / {{ lot.available_spots }} slots occupied</p>

        <div class="slot-boxes">
            {% for spot in lot.spots|sort(attribute='spot_number') %}
            <a href="{{ url_for('admin.view_spot', lot_id=lot.id, spot_number=spot.spot_number) }}" class="slot-box 
               {% if spot.status == 'O' %}
                   occupied
               {% elif spot.status == 'B' %}
                   booked
               {% elif spot.status == 'X' %}
                   unavailable
               {% endif %}" title="Spot {{ spot.spot_number }} | {{ spot.status }}">
            </a>
            {% endfor %}
        </div>

    </div>
    {% endfor %}
    {% else %}
    <div class="empty-state">
        <!-- <img src="{{ url_for('static', filename='images/empty-parking.svg') }}" alt="No parking lots" class="empty-image"> -->
        <h3>No Parking Lots Added Yet</h3>
        <p>Get started by adding your first parking lot to manage</p>
        <a href="{{ url_for('admin.add_new_parking') }}" class="add-parking-btnn">
            + Add New Parking Lot
        </a>
    </div>
    {% endif %}
</div>

{% if parking_lots %}
<a href="{{ url_for('admin.add_new_parking') }}" class="add-parking-btn">
    + Add New Parking Lot
</a>
{% endif %}

{% endblock %}
{% endblock %}