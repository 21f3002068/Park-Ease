{% extends 'admin/adash_base.html' %}


{% block title %}Users{% endblock %}

{% block custom_styles %}
<link href="{{ url_for('static', filename='style/admin/users.css') }}" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
{% endblock %}

{% block body %}
{% block content %}

<div class="details">
    <div class="users">
        <div class="cardHeader">
            <h2>Users | {{ users|length }}</h2>
            <a href="#" class="btn">View All</a>
        </div>
        <table>
            <thead>
                <tr>
                    <td>ID</td>
                    <td>User</td>
                    <td>Phone</td>
                    <td>Vehicle Name</td>
                    <td>License Plate</td>
                    <td>Actions</td>
                </tr>
            </thead>
            <tbody>
                {% for user in users %}
                <tr class="cust-row">
                    <td>
                        {% if not user.is_active %}
                        <div class="flag-indicator">
                            {{ user.id }}
                            <img src="{{ url_for('static', filename='/icons/flag_26dp_EA3323.svg') }}" alt="Flagged">
                        </div>
                        {% else %}
                        {{ user.id }}
                        {% endif %}
                    </td>
                    <td>
                        <a href="{{ url_for('admin.user_detail', user_id=user.id) }}" class="view-btn">
                            {{ user.firstname }} {{ user.lastname }}
                        </a>
                    </td>
                    <td>{{ user.phone }}</td>
                    <td>
                        {% if user.vehicles %}
                        {% for vehicle in user.vehicles %}
                        <div>{{ vehicle.vehicle_name or 'N/A' }}</div>
                        {% endfor %}
                        {% else %}
                        None
                        {% endif %}
                    </td>
                    <td>
                        {% if user.vehicles %}
                        {% for vehicle in user.vehicles %}
                        <div>{{ vehicle.license_plate }}</div>
                        {% endfor %}
                        {% else %}
                        None
                        {% endif %}
                    </td>
                    <td>
                        {% if user.is_active == False %}
                        <a href="#">
                            <button class="unflag-btn">UnFlag</button>
                        </a>
                        {% else %}
                        <a href="{{ url_for('admin.flag_user_confirmation', user_type='user', user_id=user.id) }}">
                            <button class="flag-btn">Flag</button>
                        </a>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    <div class="chart-container" style="width: 100%; max-width: 600px; margin: auto;">
        <div class="pie-container"
            style="width: 30%; display: inline-block; vertical-align: bottom; margin-right: 6%; margin-left: 5%;">
            <canvas id="usersPieChart"></canvas>
        </div>
        <div class="pie-container" style="width: 48%; display: inline-block; vertical-align: bottom;">
            <canvas id="usersChart"></canvas>
        </div>
        <div class="line-container"
            style="width: 100%; max-width: 500px; margin: auto; display: block; margin-top: 20px;">
            <canvas id="userBookingsChart"></canvas>
        </div>
    </div>


</div>

<script>

    // Prepare data for the pie chart
    const activeCount = '{{ users | selectattr('is_active', 'equalto', true) | list | length | tojson }}';
    const inactiveCount = '{{ users | selectattr('is_active', 'equalto', false) | list | length | tojson }}';

    const pieData = {
        labels: ['Active users', 'Inactive users'],
        datasets: [{
            label: 'user Status',
            data: [activeCount, inactiveCount],
            backgroundColor: ['rgba(75, 192, 192, 0.2)', 'rgba(255, 99, 132, 0.2)'],
            borderColor: ['rgba(75, 192, 192, 1)', 'rgba(255, 99, 132, 1)'],
            borderWidth: 1
        }]
    };

    // Configuring the pie chart
    const pieConfig = {
        type: 'doughnut',
        data: pieData,
    };

    // Rendering the pie chart
    const usersPieChart = new Chart(
        document.getElementById('usersPieChart'),
        pieConfig
    );














    const userIds = {{ users | map(attribute = 'id') | list | tojson }};
    const bookingCounts = {{ users | map(attribute = 'bookings') | map('length') | list | tojson }}; // Count bookings per user

    const bookingsData = {
        labels: userIds,
        datasets: [{
            label: 'Number of Bookings per user',
            data: bookingCounts,
            backgroundColor: 'rgba(153, 102, 255, 0.2)',
            borderColor: 'rgba(153, 102, 255, 1)',
            borderWidth: 1
        }]
    };

    // Configuring the bookings chart
    const bookingsConfig = {
        type: 'bar',
        data: bookingsData,
        options: {
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    };

    // Rendering the bookings chart
    const userBookingsChart = new Chart(
        document.getElementById('userBookingsChart'),
        bookingsConfig
    );











    // Prepare data for the chart
    const labels = {{ users | map(attribute = 'registration_date') | list | tojson }}; // Example to get registration dates
    const dataCount = {{ users | map(attribute = 'id') | list | length | tojson }}; // Convert to list before counting

    console.log('Labels:', labels); // Log labels
    console.log('Data Count:', dataCount); // Log data count

    const data = {
        labels: labels,
        datasets: [{
            label: 'Number of users',
            data: [dataCount], // Create an array for the data
            backgroundColor: 'rgba(75, 192, 192, 0.2)',
            borderColor: 'rgba(75, 192, 192, 1)',
            borderWidth: 1
        }]
    };

    // Configuring the chart
    const config = {
        type: 'bar',
        data: data,
        options: {
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    };

    // Rendering the chart
    const usersChart = new Chart(
        document.getElementById('usersChart'),
        config
    );










</script>


{% endblock %}
{% endblock %}