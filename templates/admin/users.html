{% extends 'admin/adash_base.html' %}


{% block title %}Users{% endblock %}

{% block custom_styles %}
<link href="{{ url_for('static', filename='style/admin/users.css') }}" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
{% endblock %}

{% block body %}
{% with messages = get_flashed_messages(with_categories=true) %}
{% if messages %}
<ul class="flash-messages">
    {% for category, message in messages %}
    <li class="flash {{ category }}">{{ message }}</li>
    {% endfor %}
</ul>
{% endif %}
{% endwith %}
{% block content %}

<div class="details">
    <div class="users">
        <div class="cardHeader">
            <h2>Users | {{ users|length }}</h2>
            <a href="{{url_for('admin.flagged_users')}}" class="btn"
                style="background-color: #a32217; color !important: white;">View Flagged</a>
        </div>
        <table>
            <thead>
                <tr>
                    <td>ID</td>
                    <td>User</td>
                    <td>Phone</td>
                    <td>Vehicle Name</td>
                    <td>License Plate</td>
                    <td>Actions</td>
                </tr>
            </thead>
            <tbody>
                {% for user in users %}
                <tr class="cust-row">
                    <td>
                        {% if user.is_flagged %}
                        <div class="flag-indicator">
                            {{ user.id }}
                            <img src="{{ url_for('static', filename='/icon/flag_26dp_EA3323.svg') }}" alt="Flagged">
                        </div>
                        {% else %}
                        {{ user.id }}
                        {% endif %}
                    </td>
                    <td>
                        <a href="{{ url_for('admin.user_detail', user_id=user.id) }}" class="view-btn"
                            style="text-decoration: none; color: blue; background-color: rgb(215, 241, 250); padding: 2px 5px; border-radius: 5px;">
                            {{ user.firstname }} {{ user.lastname }}
                        </a>
                    </td>
                    <td>{{ user.phone }}</td>
                    <td>
                        {% if user.vehicles %}
                        {% for vehicle in user.vehicles %}
                        <div>{{ vehicle.vehicle_name or 'N/A' }}</div>
                        {% endfor %}
                        {% else %}
                        None
                        {% endif %}
                    </td>
                    <td>
                        {% if user.vehicles %}
                        {% for vehicle in user.vehicles %}
                        <div>{{ vehicle.license_plate }}</div>
                        {% endfor %}
                        {% else %}
                        None
                        {% endif %}
                    </td>
                    <td>
                        {% if user.is_flagged %}
                        <form action="{{ url_for('admin.unflag_user', id=user.id) }}" method="POST"
                            style="display:inline;">
                            <button type="submit" class="unflag-btn">Unflag</button>
                        </form>
                        {% else %}
                        <a href="{{ url_for('admin.flag_user_confirmation', id=user.id) }}">
                            <button class="flag-btn">Flag</button>
                        </a>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    <div class="chart-container" style="width: 100%; max-width: 600px; margin: auto;">
        <div class="pie-container"
            style="width: 30%; display: inline-block; vertical-align: bottom; margin-right: 6%; margin-left: 5%;">
            <canvas id="usersPieChart"></canvas>
        </div>
        <div class="pie-container" style="width: 48%; display: inline-block; vertical-align: bottom;">
            <canvas id="usersChart"></canvas>
        </div>
        <div class="line-container"
            style="width: 100%; max-width: 500px; margin: auto; display: block; margin-top: 20px;">
            <canvas id="userBookingsChart"></canvas>
        </div>
    </div>


</div>

<script>

    // Prepare data for the pie chart
    const activeCount = '{{ users | selectattr('is_active', 'equalto', true) | list | length | tojson }}';
    const inactiveCount = '{{ users | selectattr('is_active', 'equalto', false) | list | length | tojson }}';

    const pieData = {
        labels: ['Active users', 'Inactive users'],
        datasets: [{
            label: 'user Status',
            data: [activeCount, inactiveCount],
            backgroundColor: ['rgba(75, 192, 192, 0.2)', 'rgba(255, 99, 132, 0.2)'],
            borderColor: ['rgba(75, 192, 192, 1)', 'rgba(255, 99, 132, 1)'],
            borderWidth: 1
        }]
    };

    // Configuring the pie chart
    const pieConfig = {
        type: 'doughnut',
        data: pieData,
    };

    // Rendering the pie chart
    const usersPieChart = new Chart(
        document.getElementById('usersPieChart'),
        pieConfig
    );



    const labels = {{ labels | tojson }};
    const counts = {{ counts | tojson }};

    const data = {
        labels: labels,
        datasets: [{
            label: 'User Registrations per Day',
            data: counts,
            backgroundColor: 'rgba(54, 162, 235, 0.2)',
            borderColor: 'rgba(54, 162, 235, 1)',
            borderWidth: 1
        }]
    };

    const config = {
        type: 'bar',
        data: data,
        options: {
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        stepSize: 1
                    }
                }
            }
        }
    };

    const usersChart = new Chart(
        document.getElementById('usersChart'),
        config
    );




    // Bookings per User Chart
    {% if user_ids is defined %}
    const userIds = {{ user_ids | tojson }};
    {% else %}
    const userIds = [];
    {% endif %} const bookingCounts = {{ booking_counts | tojson }};

    const bookingsData = {
        labels: userIds,
        datasets: [{
            label: 'Bookings per User',
            data: bookingCounts,
            backgroundColor: 'rgba(153, 102, 255, 0.2)',
            borderColor: 'rgba(153, 102, 255, 1)',
            borderWidth: 1
        }]
    };

    new Chart(document.getElementById('userBookingsChart'), {
        type: 'bar',
        data: bookingsData,
        options: {
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        stepSize: 1,
                        callback: function (value) {
                            // Only show whole numbers
                            if (Number.isInteger(value)) {
                                return value;
                            }
                        }
                    }
                }
            }
        }
    });






</script>

<script>
    // Wait for the page to load
    window.addEventListener('DOMContentLoaded', () => {
        // Find all flash messages
        const flashMessages = document.querySelectorAll('.flash');

        // Set a timeout to remove them after 5 seconds (5000 ms)
        setTimeout(() => {
            flashMessages.forEach(msg => {
                msg.style.transition = 'opacity 0.5s ease';
                msg.style.opacity = '0';
                setTimeout(() => msg.remove(), 500); // Fully remove after fade out
            });
        }, 5000);
    });
</script>

{% endblock %}
{% endblock %}